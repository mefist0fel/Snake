<html>
	<head>
		<title>Snake 3d game</title>
		<style type="text/css">
		body {
			display: block;
			background-color:0;
			width: 100%;
			height: 100%;
			margin: 0;
		}
		canvas {
			background-color:0;
			display: block;
			margin: 0px auto;
		}
		</style>
	</head>
	<body>
		<canvas id="snake"></canvas>
	</body>
	<script type="text/javascript">
	
	var MAX_NUMBER=Number.MAX_VALUE,MIN_NUMBER=Number.MIN_VALUE,PI=Math.PI,Cos=Math.cos,Sin=Math.sin;function inRect(a,b,c,d,e,f){return a>=c&&a<=e&&b>=d&&b<=f}function CreateVector2(a,b){return[void 0===a?0:a,void 0===b?0:b]}function AddVector2(a,b){return[a[0]+b[0],a[1]+b[1]]}function SubstractVector2(a,b){return[a[0]-b[0],a[1]-b[1]]}function MultiplyVector2(a,b){return[a[0]*b,a[1]*b]}function LerpVector2(a,b,c){return AddVector2(MultiplyVector2(a,1-c),MultiplyVector2(b,c))}
function Vector2Length(a){return Math.sqrt(a[0]*a[0]+a[1]*a[1])}function NormalizeVector2(a){var b=1/Vector2Length(a);Infinity==b&&(b=MAX_NUMBER);-Infinity==b&&(b=MIN_NUMBER);return MultiplyVector2(a,b)}function DotProductVector2(a,b){return a[0]*b[0]+a[1]*b[1]}function DistanceToLineDistance(a,b,c){b=SubstractVector2(b,a);b=[b[1],-b[0]];a=SubstractVector2(a,c);return Math.abs(DotProductVector2(NormalizeVector2(b),a))}
function PointToLine(a,b,c){b=SubstractVector2(b,a);b=[b[1],-b[0]];a=SubstractVector2(a,c);return DotProductVector2(NormalizeVector2(b),a)}function CreateVector3(a,b,c){return[void 0===a?0:a,void 0===b?0:b,void 0===c?0:c]}function AddVector3(a,b){return[a[0]+b[0],a[1]+b[1],a[2]+b[2]]}function SubstractVector3(a,b){return[a[0]-b[0],a[1]-b[1],a[2]-b[2]]}function MultiplyVector3(a,b){return[a[0]*b,a[1]*b,a[2]*b]}function DotProductVector3(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]}
function AngleBetweenVector3(a,b){return Math.acos(DotProductVector3(NormalizeVector3(a),NormalizeVector3(b)))/PI*180}function AxeBetweenVector3(a,b){return NormalizeVector3(CrossProductVector3(NormalizeVector3(a),NormalizeVector3(b)))}function IsEqualVector3(a,b){return.001>DistanceVector3(a,b)}function CrossProductVector3(a,b){return CreateVector3(a[1]*b[2]-a[2]*b[1],a[2]*b[0]-a[0]*b[2],a[0]*b[1]-a[1]*b[0])}function Vector3Length(a){return Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2])}
function DistanceVector3(a,b){return Vector3Length(SubstractVector3(a,b))}function NormalizeVector3(a){var b=1/Vector3Length(a);NaN==b&&(b=MAX_NUMBER);Infinity==b&&(b=MAX_NUMBER);-Infinity==b&&(b=MIN_NUMBER);return MultiplyVector3(a,b)}function LerpVector3(a,b,c){return AddVector3(MultiplyVector3(a,1-c),MultiplyVector3(b,c))}function FindMiddlePoint(a){for(var b=CreateVector3(),c=0;c<a.length;c++)b=AddVector3(b,a[c]);return MultiplyVector3(b,1/parseFloat(a.length))}
function CreateUnitMatrix3(){return[1,0,0,0,1,0,0,0,1]}function CreateMatrix3RotatedX(a){var b=(void 0===a?0:a)/180*PI;a=Cos(b);b=Sin(b);return[1,0,0,0,a,-b,0,b,a]}function CreateMatrix3RotatedY(a){var b=(void 0===a?0:a)/180*PI;a=Cos(b);b=Sin(b);return[a,0,b,0,1,0,-b,0,a]}function CreateMatrix3RotatedZ(a){var b=(void 0===a?0:a)/180*PI;a=Cos(b);b=Sin(b);return[a,-b,0,b,a,0,0,0,1]}
function CreateEulerMatrix3(a,b,c){var d=(void 0===a?0:a)/180*PI,e=(void 0===b?0:b)/180*PI,f=(void 0===c?0:c)/180*PI;c=Cos(d);b=Cos(e);a=Cos(f);d=Sin(d);e=Sin(e);f=Sin(f);return[c*a-d*e*a,-c*f-d*b*a,d*e,d*a+c*b*f,-d*f+c*b*a,-c*e,e*f,e*a,b]}function CreateRotationMatrix3(a,b){var c=a[0],d=a[1],e=a[2],f=b/180*PI,g=Cos(f);f=Sin(f);var h=1-g;return[c*c+(1-c*c)*g,c*d*h-e*f,c*e*h+d*f,c*d*h+e*f,d*d+(1-d*d)*g,d*e*h-c*f,c*e*h-d*f,d*e*h+c*f,e*e+(1-e*e)*g]}
function MultiplyMatrix3(a,b){return[a[0]*b[0]+a[1]*b[3]+a[2]*b[6],a[0]*b[1]+a[1]*b[4]+a[2]*b[7],a[0]*b[2]+a[1]*b[5]+a[2]*b[8],a[3]*b[0]+a[4]*b[3]+a[5]*b[6],a[3]*b[1]+a[4]*b[4]+a[5]*b[7],a[3]*b[2]+a[4]*b[5]+a[5]*b[8],a[6]*b[0]+a[7]*b[3]+a[8]*b[6],a[6]*b[1]+a[7]*b[4]+a[8]*b[7],a[6]*b[2]+a[7]*b[5]+a[8]*b[8]]}function MultiplyVector3ToMatrix3(a,b){return[a[0]*b[0]+a[1]*b[1]+a[2]*b[2],a[0]*b[3]+a[1]*b[4]+a[2]*b[5],a[0]*b[6]+a[1]*b[7]+a[2]*b[8]]}
function findMiddlePoint(a){for(var b=CreateVector3(),c=0;c<a.length;c++)b=AddVector3(b,a[c]);return MultiplyVector3(b,1/parseFloat(a.length))}function CreateMatrix3FromQuaternion(a){var b=a[0],c=a[1],d=a[2],e=a[3],f=b+b,g=c+c,h=d+d;a=b*f;var k=b*g;b*=h;var l=c*g;c*=h;d*=h;f*=e;g*=e;e*=h;return[1-(l+d),k+e,b-g,k-e,1-(a+d),c+f,b+g,c-f,1-(a+l)]}function CreateQuaternion(){return[0,0,0,1]}
function CreateQuaternionFromMatrix3(a){var b=Math.sqrt(1+a[0]+a[4]+a[8])/2,c=4*b;return[(a[7]-a[5])/c,(a[2]-a[6])/c,(a[3]-a[1])/c,b]}function CreateUnitMatrix4(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function CreateMatrix4FromMatrix3(a){return[a[0],a[1],a[2],0,a[3],a[4],a[5],0,a[6],a[7],a[8],0,0,0,0,1]}function CreateMatrix4(a,b){var c=void 0===b?1:b;return[c,0,0,0,0,c,0,0,0,0,c,0,a[0],a[1],a[2],1]}
function MultiplyVector3ToMatrix4(a,b){var c=MultiplyVector4ToMatrix4([a[0],a[1],a[2],1],b);return[c[0]/c[3],c[1]/c[3],c[2]/c[3]]}function MultiplyVector4ToMatrix4(a,b){return[a[0]*b[0]+a[1]*b[4]+a[2]*b[8]+a[3]*b[12],a[0]*b[1]+a[1]*b[5]+a[2]*b[9]+a[3]*b[13],a[0]*b[2]+a[1]*b[6]+a[2]*b[10]+a[3]*b[14],a[0]*b[3]+a[1]*b[7]+a[2]*b[11]+a[3]*b[15]]}
function CreateProjectionMatrix4(a,b,c,d){c=void 0===c?1:c;d=void 0===d?100:d;return[c/(void 0===b?100:b),0,0,0,0,c/(void 0===a?100:a),0,0,0,0,(d+c)/(d-c),-1,0,0,-2*d*c/(d-c),0]}
function MultiplyMatrix4(a,b){return[a[0]*b[0]+a[1]*b[4]+a[2]*b[8]+a[3]*b[12],a[0]*b[1]+a[1]*b[5]+a[2]*b[9]+a[3]*b[13],a[0]*b[2]+a[1]*b[6]+a[2]*b[10]+a[3]*b[14],a[0]*b[3]+a[1]*b[7]+a[2]*b[11]+a[3]*b[15],a[4]*b[0]+a[5]*b[4]+a[6]*b[8]+a[7]*b[12],a[4]*b[1]+a[5]*b[5]+a[6]*b[9]+a[7]*b[13],a[4]*b[2]+a[5]*b[6]+a[6]*b[10]+a[7]*b[14],a[4]*b[3]+a[5]*b[7]+a[6]*b[11]+a[7]*b[15],a[8]*b[0]+a[9]*b[4]+a[10]*b[8]+a[11]*b[12],a[8]*b[1]+a[9]*b[5]+a[10]*b[9]+a[11]*b[13],a[8]*b[2]+a[9]*b[6]+a[10]*b[10]+a[11]*b[14],a[8]*
b[3]+a[9]*b[7]+a[10]*b[11]+a[11]*b[15],a[12]*b[0]+a[13]*b[4]+a[14]*b[8]+a[15]*b[12],a[12]*b[1]+a[13]*b[5]+a[14]*b[9]+a[15]*b[13],a[12]*b[2]+a[13]*b[6]+a[14]*b[10]+a[15]*b[14],a[12]*b[3]+a[13]*b[7]+a[14]*b[11]+a[15]*b[15]]}
function Input(){function a(a){a=[];for(var b=0;200>b;b++)a[b]=!1;return a}function b(a){e.touches=c(a);a.preventDefault()}function c(a){for(var b=[],c=0;c<a.touches.length;c++)b.push([a.touches[c].clientX,a.touches[c].clientY]);return b}function d(a,b){document.addEventListener(a,b,{passive:!1})}var e={keyPressed:a(),keyDown:a(),mouseLeft:!1,mouseLeftDown:!1,mousePosition:[0,0],touches:[],touchesDown:[],isTouchInRect:function(a,b,c,d){if(this.mouseLeft&&inRect(this.mousePosition[0],this.mousePosition[1],
a,b,c,d))return!0;for(var f=0;f<this.touches.length;f++)if(inRect(this.touches[f][0],this.touches[f][1],a,b,c,d))return!0;return!1},isTouchDownInRect:function(a,b,c,d){if(this.mouseLeftDown&&inRect(this.mousePosition[0],this.mousePosition[1],a,b,c,d))return!0;for(var f=0;f<this.touchesDown.length;f++)if(inRect(this.touchesDown[f][0],this.touchesDown[f][1],a,b,c,d))return!0;return!1},updateInput:function(){this.mouseLeftDown=!1;this.keyDown=a();this.touchesDown=[]}};d("mousedown",function(a){e.mouseLeft=
!0;e.mouseLeftDown=!0;e.mousePosition[0]=a.clientX;e.mousePosition[1]=a.clientY});d("mouseup",function(a){e.mouseLeft=!1;e.mousePosition[0]=a.clientX;e.mousePosition[1]=a.clientY});d("mousemove",function(a){e.mousePosition[0]=a.clientX;e.mousePosition[1]=a.clientY});d("keydown",function(a){e.keyDown[a.keyCode]=!0;e.keyPressed[a.keyCode]=!0});d("keyup",function(a){e.keyPressed[a.keyCode]=!1});d("touchstart",function(a){e.touchesDown=c(a);b(a)});d("touchmove",b);d("touchend",b);d("touchcancel",b);return e}
var Camera=function(a,b,c){this.objects=[];this.setSize(void 0===b?100:b,void 0===c?100:c);this.worldMatrix=CreateUnitMatrix3();this.projectionMatrix=CreateProjectionMatrix4(1,1,1,2);this.cameraPosition=CreateVector3(0,0,20);this.position=CreateVector3();this.canvas=a;Camera.instance=this};Camera.prototype.setSize=function(a,b){this.screenWidht=a;this.screenHeight=b;this.centerOffcet=CreateVector3(.5*a,.5*b);this.screenScale=Math.min(a,b)};
Camera.prototype.render=function(){for(var a=0;a<this.objects.length;a++)this.objects[a].prepareScene(this);this.objects.sort(object3DDepthComparator);for(a=0;a<this.objects.length;a++)this.objects[a].draw(this.canvas)};
Camera.prototype.worldToScreenVector3=function(a){a=AddVector3(a,MultiplyVector3(this.position,-1));a=MultiplyVector3ToMatrix3(a,this.worldMatrix);a=AddVector3(a,this.cameraPosition);a=MultiplyVector3ToMatrix4(a,this.projectionMatrix);a=MultiplyVector3(a,this.screenScale);return AddVector3(a,this.centerOffcet)};
Camera.prototype.worldToScreenVector3WithOffcet=function(a,b){var c=AddVector3(a,MultiplyVector3(this.position,-1));c=MultiplyVector3ToMatrix3(c,this.worldMatrix);c=AddVector3(c,this.cameraPosition);c=AddVector3(c,b);c=MultiplyVector3ToMatrix4(c,this.projectionMatrix);c=MultiplyVector3(c,this.screenScale);return AddVector3(c,this.centerOffcet)};
var Object3D=function(a,b,c){b=void 0===b?.5:b;c=void 0===c?"#FFEEEE":c;this.position=a;this.screenPosition=CreateVector3();this.color=c;this.radiusPositionVector=CreateVector3(b);this.screenRadius=10;this.enabled=!0;Camera.instance.objects.push(this)};Object3D.prototype.setRadius=function(a){this.radiusPositionVector=CreateVector3(a)};
Object3D.prototype.prepareScene=function(a){this.enabled&&(this.screenPosition=a.worldToScreenVector3(this.position),a=a.worldToScreenVector3WithOffcet(this.position,this.radiusPositionVector),a=SubstractVector3(this.screenPosition,a),this.screenRadius=Vector3Length(a))};Object3D.prototype.draw=function(a){this.enabled&&(a.fillStyle=this.color,a.beginPath(),a.arc(this.screenPosition[0],this.screenPosition[1],this.screenRadius,0,2*Math.PI),a.closePath(),a.fill())};
var Object3DTriangle=function(a,b,c,d,e,f){d=void 0===d?"#FFEEEE":d;e=void 0===e?!0:e;f=void 0===f?!0:f;this.points=[a,b,c];this.screenPoints=[a,b,c];this.position=FindMiddlePoint(this.points);this.screenPosition=CreateVector3();this.color=d;this.ignoreBackface=f;this.filled=e;this.enabled=!0;Camera.instance.objects.push(this)};
Object3DTriangle.prototype.prepareScene=function(a){if(this.enabled){this.screenPosition=a.worldToScreenVector3(this.position);for(var b=0;b<this.screenPoints.length;b++)this.screenPoints[b]=a.worldToScreenVector3(this.points[b])}};
Object3DTriangle.prototype.draw=function(a){if(this.enabled&&!(this.ignoreBackface&&0<PointToLine(this.screenPoints[0],this.screenPoints[1],this.screenPoints[2]))){a.fillStyle=this.color;a.strokeStyle=this.color;a.beginPath();var b=this.screenPoints[this.screenPoints.length-1];a.moveTo(b[0],b[1]);for(b=0;b<this.screenPoints.length;b++)a.lineTo(this.screenPoints[b][0],this.screenPoints[b][1]);a.closePath();this.filled&&a.fill();a.stroke()}};
function object3DDepthComparator(a,b){return a.screenPosition[2]<b.screenPosition[2]?-1:a.screenPosition[2]>b.screenPosition[2]?1:0}var Level=function(a){this.setLevel(void 0===a?0:a)};
Level.prototype.setLevel=function(a){this.id=a;Camera.instance.objects=[];this.navigationObjects=null;this.livesCount=3;this.applesCount=0;this.applesNeed=6+3*a;this.needRocks=parseInt(a/4+2);this.navigationNodes=[];var b=null;if(0==a||a%3==parseInt(a/3)%3)this.needRocks=0;switch(a%4){case 0:createSphere();b=CreateNavigationSphere();break;case 1:createCube(8);b=CreateNavigationCube(8);break;case 2:createCilynder();b=createNavigationCilynder();break;case 3:createTorus(),b=CreateNavigationTorus()}for(a=
0;a<b.length;a++){var c=b[a];this.navigationNodes.push(new NavigationNode(c[0],c[1],c[2]))}this.navigationMesh=new NavigationMesh(this.navigationNodes);this.snake=new Snake(this.navigationMesh);this.snake.setEnabled(!1);this.apples=[new Apple(CreateVector3(),rgbToHex(51,255,51)),new Apple(CreateVector3(),rgbToHex(51,255,51)),new Apple(CreateVector3(),rgbToHex(51,255,51))];this.rocks=[];for(b=0;b<this.needRocks;b++)this.rocks.push(new Apple(CreateVector3(),rgbToHex(0,0,200)))};
Level.prototype.update=function(a){for(var b=0;b<this.apples.length;b++)this.apples[b].update(a);for(b=0;b<this.rocks.length;b++)this.rocks[b].update(a);for(a=0;a<this.apples.length;a++)1>DistanceVector3(this.navigationMesh.heroPosition,this.apples[a].position)&&(this.apples[a].remove(this.getRandomPosition()),this.snake.lenght+=.5,this.applesCount+=1);for(a=0;a<this.rocks.length;a++)1>DistanceVector3(this.navigationMesh.heroPosition,this.rocks[a].position)&&(this.rocks[a].remove(this.getRandomPosition()),
this.snake.lenght-=.2,--this.livesCount);for(a=6;a<this.snake.tailPoints.length-1;a++)1>DistanceVector3(this.navigationMesh.heroPosition,this.snake.tailPoints[a])&&(this.livesCount=0)};Level.prototype.getRandomPosition=function(){do var a=this.navigationMesh.getRandomPosition();while(this.hasCollisions(a));return a};
Level.prototype.hasCollisions=function(a){for(var b=0;b<this.apples.length;b++)if(1>DistanceVector3(a,this.apples[b].position))return!0;for(b=0;b<this.rocks.length;b++)if(1>DistanceVector3(a,this.rocks[b].position))return!0;return!1};Level.prototype.start=function(){this.snake.setEnabled(!0);for(var a=0;a<this.apples.length;a++)this.apples[a].remove(this.navigationMesh.getRandomPosition());for(a=0;a<this.rocks.length;a++)this.rocks[a].remove(this.navigationMesh.getRandomPosition())};
Level.prototype.hideLevelDetails=function(){this.snake.setEnabled(!1);for(var a=0;a<this.apples.length;a++)this.apples[a].remove(CreateVector3());for(a=0;a<this.rocks.length;a++)this.rocks[a].remove(CreateVector3())};Level.prototype.showDebugInfo=function(a){null==this.navigationObjects&&(this.navigationObjects=this.createNavigationInfo());for(var b=0;b<this.navigationObjects.length;b++)this.navigationObjects[b].enabled=a};
Level.prototype.createNavigationInfo=function(){for(var a=[],b=0;b<this.navigationNodes.length;b++){var c=new Object3DTriangle(this.navigationNodes[b].pointA,this.navigationNodes[b].pointB,this.navigationNodes[b].pointC,"rgb(255,255,255)",!1,!1);a.push(c)}a.push(new Object3D(CreateVector3(8,0,0),.5,rgbToHex(255,0,0)));a.push(new Object3D(CreateVector3(0,8,0),.5,rgbToHex(0,255,0)));a.push(new Object3D(CreateVector3(0,0,8),.5,rgbToHex(0,0,255)));return a};
function createCube(a,b){b=void 0===b?11:b;for(var c=[],d=2/b,e=.5*(void 0===a?10:a),f=function(a,b,c,d,e){a=CreateVector3(a*c-1,b*c-1,1);return MultiplyVector3ToMatrix3(MultiplyVector3(a,d),e)},g=[CreateMatrix3RotatedX(0),CreateMatrix3RotatedX(90),CreateMatrix3RotatedX(180),CreateMatrix3RotatedX(270),CreateMatrix3RotatedY(90),CreateMatrix3RotatedY(270)],h=[.5,.6,.7,.8,.9,1],k=0;k<g.length;k++)for(var l=0;l<b;l++)for(var m=0;m<b;m++){var n=f(l,m,d,e,g[k]),v=f(l+1,m,d,e,g[k]),r=f(l+1,m+1,d,e,g[k]),
t=f(l,m+1,d,e,g[k]),u=parseInt(255*h[k]),p=parseInt(195*h[k]);u=rgbToHex(u,u,u);1==(l+m)%2&&(u=rgbToHex(p,p,p));c.push(new Object3DTriangle(n,v,r,u));c.push(new Object3DTriangle(n,r,t,u))}return c}
function CreateNavigationCube(a,b){a=void 0===a?9:a;b=void 0===b?.5:b;for(var c=[CreateMatrix3RotatedX(0),CreateMatrix3RotatedX(90),CreateMatrix3RotatedX(180),CreateMatrix3RotatedX(270),CreateMatrix3RotatedY(90),CreateMatrix3RotatedY(270)],d=[],e=0;e<c.length;e++){for(var f=[],g,h=0;6>h;h++)for(var k=0;6>k;k++){g=NormalizeVector3(CreateVector3(3<=h?.5*(h-3):-.5*(2-h),3<=k?.5*(k-3):-.5*(2-k),1));g=MultiplyVector3(g,b);var l=.5*a,m=.5*a;g=AddVector3(g,CreateVector3(3<=h?l:-l,3<=k?m:-m,.5*a));f[h+6*
k]=MultiplyVector3ToMatrix3(g,c[e])}for(g=0;5>g;g++)for(h=0;5>h;h++)d.push([f[g+6*h],f[g+1+6*h],f[g+1+6*(h+1)]]),d.push([f[g+6*h],f[g+1+6*(h+1)],f[g+6*(h+1)]])}return d}function pointsByIds(a,b){for(var c=[],d=0;d<b.length;d++)c.push([a[b[d][0]],a[b[d][1]],a[b[d][2]]]);return c}
function createSphere(a,b){a=void 0===a?5:a;b=void 0===b?9:b;for(var c=[],d=1/b,e=function(a,b,c,d,e){a=CreateVector3(a*c-.5,b*c-.5,.5);return MultiplyVector3ToMatrix3(MultiplyVector3(NormalizeVector3(a),d),e)},f=[CreateMatrix3RotatedX(0),CreateMatrix3RotatedX(90),CreateMatrix3RotatedX(180),CreateMatrix3RotatedX(270),CreateMatrix3RotatedY(90),CreateMatrix3RotatedY(270)],g=0;g<f.length;g++)for(var h=0;h<b;h++)for(var k=0;k<b;k++){var l=e(h,k,d,a,f[g]),m=e(h+1,k,d,a,f[g]),n=e(h+1,k+1,d,a,f[g]),v=e(h,
k+1,d,a,f[g]),r=.5*e(h+.5,k+.5,d,1,f[g])[0]+.5,t=parseInt(255*(.6*r+.4));r=parseInt(195*(.6*r+.4));t=rgbToHex(t,t,t);1==(h+k)%2&&(t=rgbToHex(r,r,r));c.push(new Object3DTriangle(l,m,n,t));c.push(new Object3DTriangle(l,n,v,t))}return c}
function CreateNavigationSphere(a,b,c){c=void 0===c?9:c;var d=[],e=1/c;a=(void 0===a?5:a)+(void 0===b?.5:b);b=function(a,b,c,d,e){a=CreateVector3(a*c-.5,b*c-.5,.5);return MultiplyVector3ToMatrix3(MultiplyVector3(NormalizeVector3(a),d),e)};for(var f=[CreateMatrix3RotatedX(0),CreateMatrix3RotatedX(90),CreateMatrix3RotatedX(180),CreateMatrix3RotatedX(270),CreateMatrix3RotatedY(90),CreateMatrix3RotatedY(270)],g=0;g<f.length;g++)for(var h=0;h<c;h++)for(var k=0;k<c;k++){var l=b(h,k,e,a,f[g]),m=b(h+1,k,
e,a,f[g]),n=b(h+1,k+1,e,a,f[g]),v=b(h,k+1,e,a,f[g]);d.push([l,m,n]);d.push([l,n,v])}return d}
function createCilynder(a,b,c,d,e){a=void 0===a?32:a;b=void 0===b?4:b;c=void 0===c?7:c;d=void 0===d?8:d;e=void 0===e?6:e;for(var f=[],g=[],h=0;h<=a;h++){var k=360/a*h;k=MultiplyVector3ToMatrix3(CreateVector3(b,0,0),CreateMatrix3RotatedY(k));g.push(k)}h=CreateVector3(0,.5*c,0);c=CreateVector3(0,.5*-c,0);k=1/d;for(var l=1/e,m=0;m<a;m++){for(var n,v=AddVector3(h,g[m]),r=AddVector3(h,g[m+1]),t=AddVector3(c,g[m]),u=AddVector3(c,g[m+1]),p=0;p<e;p++){var q=(e-p)*l*30;n=rgbToHex(195+q,195+q,195+q);1==(m+
p)%2&&(n=rgbToHex(255-q,255-q,255-q));upperStart=LerpVector3(h,v,p*l);upperEnd=LerpVector3(h,r,p*l);downerStart=LerpVector3(h,v,(p+1)*l);downerEnd=LerpVector3(h,r,(p+1)*l);f.push(new Object3DTriangle(upperStart,downerEnd,upperEnd,n));f.push(new Object3DTriangle(upperStart,downerStart,downerEnd,n))}for(p=0;p<e;p++)q=(e-p)*l*30,n=rgbToHex(195+q,195+q,195+q),1==(m+p)%2&&(n=rgbToHex(255-q,255-q,255-q)),upperStart=LerpVector3(c,t,(p+1)*l),upperEnd=LerpVector3(c,u,(p+1)*l),downerStart=LerpVector3(c,t,p*
l),downerEnd=LerpVector3(c,u,p*l),f.push(new Object3DTriangle(upperStart,downerEnd,upperEnd,n)),f.push(new Object3DTriangle(upperStart,downerStart,downerEnd,n));for(p=0;p<d;p++)q=v[0]/b*.5+.5,n=parseInt(255*(.6*q+.4)),q=parseInt(195*(.6*q+.4)),n=rgbToHex(n,n,n),1==(m+p)%2&&(n=rgbToHex(q,q,q)),upperStart=LerpVector3(v,t,p*k),upperEnd=LerpVector3(r,u,p*k),downerStart=LerpVector3(v,t,(p+1)*k),downerEnd=LerpVector3(r,u,(p+1)*k),f.push(new Object3DTriangle(upperStart,downerEnd,upperEnd,n)),f.push(new Object3DTriangle(upperStart,
downerStart,downerEnd,n))}return f}
function createNavigationCilynder(a,b,c,d){a=void 0===a?16:a;b=void 0===b?4:b;c=void 0===c?7:c;d=void 0===d?.5:d;b=[[b,.5*c+d],[b+.5*d,.5*c+.85*d],[b+.85*d,.5*c+.5*d],[b+d,.5*c],[b+d,.5*-c],[b+.85*d,.5*-c-.5*d],[b+.5*d,.5*-c-.85*d],[b,.5*-c-d]];for(var e=[],f=0;f<=a;f++){var g=360/a*f;g=MultiplyVector3ToMatrix3(CreateVector3(1,0,0),CreateMatrix3RotatedY(g));e.push(g)}f=CreateVector3(0,.5*c+d,0);c=CreateVector3(0,.5*-c-d,0);d=[];for(g=0;g<a;g++){for(var h=[],k=[],l=0;l<b.length;l++)h.push(AddVector3(CreateVector3(0,
b[l][1]),MultiplyVector3(e[g],b[l][0]))),k.push(AddVector3(CreateVector3(0,b[l][1]),MultiplyVector3(e[g+1],b[l][0])));l=h.length-1;d.push([f,h[0],k[0]]);d.push([c,k[l],h[l]]);for(l=0;l<b.length-1;l++)d.push([h[l],k[l+1],k[l]]),d.push([h[l],h[l+1],k[l+1]])}return d}
function createTorus(a,b,c,d){a=void 0===a?5:a;b=void 0===b?2:b;c=void 0===c?46:c;d=void 0===d?16:d;for(var e=[],f=[],g=0;g<=c;g++){for(var h=CreateMatrix3RotatedY(360/c*g),k=[],l=0;l<=d;l++){var m=360/d*l;m=MultiplyVector3ToMatrix3(AddVector3(MultiplyVector3ToMatrix3(CreateVector3(b,0,0),CreateMatrix3RotatedZ(m)),CreateVector3(a,0,0)),h);k.push(m)}f.push(k)}a=1/d;for(b=0;b<c;b++)for(g=0;g<d;g++)k=parseInt(Math.abs(g-.5*d)*a*30),h=rgbToHex(195+k,195+k,195+k),1==(b+g)%2&&(h=rgbToHex(255-k,255-k,255-
k)),k=f[b][g],l=f[b+1][g],m=f[b+1][g+1],e.push(new Object3DTriangle(k,m,f[b][g+1],h)),e.push(new Object3DTriangle(k,l,m,h));return e}
function CreateNavigationTorus(a,b,c,d,e){a=void 0===a?5:a;b=void 0===b?2:b;c=void 0===c?46:c;d=void 0===d?16:d;e=void 0===e?.5:e;for(var f=[],g=[],h=0;h<=c;h++){for(var k=CreateMatrix3RotatedY(360/c*h),l=[],m=0;m<=d;m++){var n=360/d*m;n=MultiplyVector3ToMatrix3(AddVector3(MultiplyVector3ToMatrix3(CreateVector3(b+e,0,0),CreateMatrix3RotatedZ(n)),CreateVector3(a,0,0)),k);l.push(n)}g.push(l)}for(a=0;a<c;a++)for(b=0;b<d;b++)f.push([g[a][b],g[a+1][b],g[a+1][b+1]]),f.push([g[a][b],g[a+1][b+1],g[a][b+1]]);
return f}function createRotationBody(a,b){b=void 0===b?16:b;for(var c=[],d=[],e=0;e<=b;e++){var f=360/b*e;f=MultiplyVector3ToMatrix3(CreateVector3(radius+navigationRadius,0,0),CreateMatrix3RotatedY(f));d.push(f)}e=CreateVector3(0,.5*height+navigationRadius,0);f=CreateVector3(0,.5*-height-navigationRadius,0);for(var g=0;g<b;g++){var h=AddVector3(e,d[g]),k=AddVector3(e,d[g+1]),l=AddVector3(f,d[g]),m=AddVector3(f,d[g+1]);c.push([e,h,k]);c.push([f,m,l]);c.push([h,m,k]);c.push([h,l,m])}return c}
function rgbToHex(a,b,c,d){function e(a){a=a.toString(16);return 1==a.length?"0"+a:a}d=void 0===d?255:d;return"#"+e(a)+e(b)+e(c)+e(d)}
var NavigationMesh=function(a,b){this.nodes=a=void 0===a?[]:a;this.currentNode=this.nodes[void 0===b?0:b];this.heroPosition=this.currentNode.center;this.heroVector=this.currentNode.unitTangent;this.heroNormal=this.currentNode.unitNormal;this.nodeAreas=[];this.fullMeshArea=this.findAreas(this.nodeAreas,this.nodes);for(var c=0;c<a.length;c++)a[c].name=c;for(c=0;c<a.length;c++)for(var d=0;d<a.length;d++)c!=d&&a[c].TryAddNeigbhorNode(a[d])};
NavigationMesh.prototype.findAreas=function(a,b){for(var c=0,d=0;d<b.length;d++)a.push({node:b[d],value:c}),c+=b[d].area;return c};NavigationMesh.prototype.push=function(a){this.triangles.push(a)};NavigationMesh.prototype.getRandomPosition=function(){var a=binarySearch(this.nodeAreas,Math.random()*this.fullMeshArea,function(a,c){return c.value-a});return this.nodes[Math.abs(a)].GetRandomPosition()};
NavigationMesh.prototype.moveHero=function(a){a=AddVector3(this.heroPosition,MultiplyVector3(this.heroVector,void 0===a?1:a));this.currentNode.IsOutABEdge(a)?null!=this.currentNode.edgeNeigbhorAB&&this.moveTo(this.currentNode.edgeNeigbhorAB,this.currentNode.pointA,this.currentNode.unitEdgeVectorAB,this.currentNode.unitEdgeNormalAB):this.currentNode.IsOutBCEdge(a)?null!=this.currentNode.edgeNeigbhorBC&&this.moveTo(this.currentNode.edgeNeigbhorBC,this.currentNode.pointB,this.currentNode.unitEdgeVectorBC,
this.currentNode.unitEdgeNormalBC):this.currentNode.IsOutCAEdge(a)?null!=this.currentNode.edgeNeigbhorCA&&this.moveTo(this.currentNode.edgeNeigbhorCA,this.currentNode.pointC,this.currentNode.unitEdgeVectorCA,this.currentNode.unitEdgeNormalCD):this.heroPosition=a};
NavigationMesh.prototype.moveTo=function(a,b,c,d){var e=this.FindPositionOnDifferentNode(this.currentNode,a,this.heroPosition,b,c,d);b=this.FindPositionOnDifferentNode(this.currentNode,a,AddVector3(this.heroPosition,this.heroVector),b,c,d);b=SubstractVector3(b,e);this.currentNode=a;this.heroPosition=e;this.heroVector=b;this.heroNormal=this.currentNode.unitNormal};
NavigationMesh.prototype.FindPositionOnDifferentNode=function(a,b,c,d,e,f){c=SubstractVector3(c,d);a=DotProductVector3(e,c);b=CrossProductVector3(b.unitNormal,e);f=DotProductVector3(f,c);return[d[0]+e[0]*a+b[0]*f,d[1]+e[1]*a+b[1]*f,d[2]+e[2]*a+b[2]*f]};NavigationMesh.prototype.rotateHeroDirection=function(a){this.heroVector=NormalizeVector3(MultiplyVector3ToMatrix3(this.heroVector,CreateRotationMatrix3(this.currentNode.unitNormal,void 0===a?0:a)))};
function binarySearch(a,b,c){for(var d=0,e=a.length-1,f=Math.floor((d+e)/2);d<=e;){var g=c(b,a[f]);if(0<g)e=f-1;else if(0>g)d=f+1;else return f;f=Math.floor((d+e)/2)}return-f}
var NavigationNode=function(a,b,c){this.pointA=a;this.pointB=b;this.pointC=c;this.points=[a,b,c];var d=FindMiddlePoint([a,b,c]);this.center=d;var e=SubstractVector3(b,d),f=SubstractVector3(c,d);this.normal=e=CrossProductVector3(e,f);this.unitNormal=NormalizeVector3(e);this.unitTangent=NormalizeVector3(SubstractVector3(b,d));this.unitBinormal=NormalizeVector3(CrossProductVector3(this.unitNormal,this.unitTangent));d=SubstractVector3(b,a);e=SubstractVector3(c,b);f=SubstractVector3(a,c);this.edgePointAB=
this.pointA;this.edgeUnitAB=NormalizeVector3(d);this.edgeNormalAB=NormalizeVector3(CrossProductVector3(this.unitNormal,d));this.edgePointBC=this.pointB;this.edgeUnitBC=NormalizeVector3(e);this.edgeNormalBC=NormalizeVector3(CrossProductVector3(this.unitNormal,e));this.edgePointCA=this.pointC;this.edgeUnitCA=NormalizeVector3(f);this.edgeNormalCA=NormalizeVector3(CrossProductVector3(this.unitNormal,f));this.area=this.GetArea(Vector3Length(d),Vector3Length(e),Vector3Length(f));this.edgeNeigbhorCA=this.edgeNeigbhorBC=
this.edgeNeigbhorAB=null;this.unitEdgeVectorAB=NormalizeVector3(SubstractVector3(b,a));this.unitEdgeVectorBC=NormalizeVector3(SubstractVector3(c,b));this.unitEdgeVectorCA=NormalizeVector3(SubstractVector3(a,c));this.unitEdgeNormalAB=CrossProductVector3(this.unitNormal,this.unitEdgeVectorAB);this.unitEdgeNormalBC=CrossProductVector3(this.unitNormal,this.unitEdgeVectorBC);this.unitEdgeNormalCD=CrossProductVector3(this.unitNormal,this.unitEdgeVectorCA)};
NavigationNode.prototype.GetArea=function(a,b,c){var d=.5*(a+b+c);return Math.sqrt(d*(d-a)*(d-b)*(d-c))};NavigationNode.prototype.TryAddNeigbhorNode=function(a){for(var b=0;b<a.points.length;b++){var c=a.points[b],d=a.points[(b+1)%a.points.length];if(this.isCommonEdge(this.pointA,this.pointB,c,d)){this.edgeNeigbhorAB=a;break}if(this.isCommonEdge(this.pointB,this.pointC,c,d)){this.edgeNeigbhorBC=a;break}if(this.isCommonEdge(this.pointC,this.pointA,c,d)){this.edgeNeigbhorCA=a;break}}};
NavigationNode.prototype.GetRandomPosition=function(){var a=Math.random(),b=Math.random();1<a+b&&(a=1-a,b=1-b);var c=SubstractVector3(this.pointB,this.pointA),d=SubstractVector3(this.pointC,this.pointA);return AddVector3(this.pointA,AddVector3(MultiplyVector3(c,a),MultiplyVector3(d,b)))};NavigationNode.prototype.isCommonEdge=function(a,b,c,d){return IsEqualVector3(a,c)&&IsEqualVector3(b,d)||IsEqualVector3(a,d)&&IsEqualVector3(b,c)};
NavigationNode.prototype.IsOutABEdge=function(a){return 0>this.GetDistanceToEdge(a,this.edgePointAB,this.edgeNormalAB)};NavigationNode.prototype.IsOutBCEdge=function(a){return 0>this.GetDistanceToEdge(a,this.edgePointBC,this.edgeNormalBC)};NavigationNode.prototype.IsOutCAEdge=function(a){return 0>this.GetDistanceToEdge(a,this.edgePointCA,this.edgeNormalCA)};NavigationNode.prototype.GetDistanceToEdge=function(a,b,c){a=SubstractVector3(a,b);return DotProductVector3(c,a)};
NavigationNode.prototype.GetDistanceToPlane=function(a){a=SubstractVector3(a,this.center);return DotProductVector3(this.unitNormal,a)};NavigationNode.prototype.GetProjectionPoint=function(a){var b=this.GetDistanceToPlane(a);return AddVector3(a,MultiplyVector3(this.unitNormal,-b))};var Apple=function(a,b,c,d){c=void 0===c?.4:c;d=void 0===d?6:d;this.position=a;this.object3d=new Object3D(a,0,b);this.radius=c;this.anim=0;this.animSpeed=d};Apple.prototype.remove=function(a){this.position=a;this.anim=-Math.abs(this.anim)};
Apple.prototype.update=function(a){1>this.anim&&(a=this.anim+this.animSpeed*a,1<a?a=1:0>this.anim&&0<a&&(this.object3d.position=this.position),this.anim=a,this.object3d.setRadius(this.radius*Math.abs(this.anim)))};
var Snake=function(a){this.navigationMesh=a;this.position=a.heroPosition;this.heroView=new Object3D(this.position,.45,rgbToHex(40,140,40));a=AddVector3(this.position,MultiplyVector3(a.heroVector,.525));this.targetView=new Object3D(a,.1,rgbToHex(30,130,30));this.rotationAngle=0;this.lenght=3.5;this.tailPoints=[];this.tailView=[];this.prevTailPosition=this.position;this.enabled=!0};Snake.prototype.rotate=function(a){this.rotationAngle=a};
Snake.prototype.setEnabled=function(a){this.enabled=a;this.heroView.enabled=a;this.targetView.enabled=a;for(var b=0;b<this.tailView.length;b++)this.tailView[b].enabled=a};
Snake.prototype.update=function(a){var b=140*this.rotationAngle*a;a*=1.75;this.navigationMesh.moveHero(a);this.navigationMesh.moveHero(a);this.navigationMesh.moveHero(a);this.navigationMesh.moveHero(a);this.navigationMesh.rotateHeroDirection(b);this.position=this.navigationMesh.heroPosition;this.heroView.position=this.navigationMesh.heroPosition;b=MultiplyVector3(this.navigationMesh.heroVector,.525);this.targetView.position=AddVector3(this.navigationMesh.heroPosition,b);b=DistanceVector3(this.prevTailPosition,
this.position);1<b&&(--b,a=SubstractVector3(this.position,this.prevTailPosition),a=NormalizeVector3(a),this.prevTailPosition=AddVector3(this.prevTailPosition,a),this.tailPoints.unshift(this.prevTailPosition),this.tailPoints.pop());for(a=this.tailView.length;a<this.lenght;a++)this.tailView.push(new Object3D(CreateVector3(),0,rgbToHex(40,Math.max(30,parseInt(142-3*a)),40)));for(a=this.tailPoints.length;a<this.tailView.length+1;a++)this.tailPoints.unshift(this.position);for(a=0;a<this.tailView.length;a++)this.tailView[a].position=
LerpVector3(this.tailPoints[a+1],this.tailPoints[a],b),this.tailView[a].setRadius(Math.min(.5,.25*(this.lenght-a)))};var minDt=1/30,fps,time=timestamp(),width=document.documentElement.clientWidth,height=document.documentElement.clientHeight,minSize=Math.min(width,height),selectLevelState=0,pauseState=1,gameState=3,startGameState=4,winState=5,loseState=6,state=selectLevelState,input=Input(),canvasElement=document.getElementById("snake"),canvas=canvasElement.getContext("2d"),camera=new Camera(canvas);
SetCanvasSize(width,height);var changeLevelAnim=0,changeLevelDirection=1,levelId=0,currentMatrix=CreateUnitMatrix3(),rotationAxe=NormalizeVector3(CreateVector3(1,1,1)),level=new Level,needShowDebugInfo=!1,needShowFPSInfo=!1;function timestamp(){return window.performance&&window.performance.now?window.performance.now():(new Date).getTime()}
function render(){canvas.fillStyle="#000011";canvas.fillRect(0,0,width,height);switch(state){default:case selectLevelState:renderSelectLevelState();break;case pauseState:renderPauseState();break;case startGameState:renderStartGameState();break;case gameState:renderGameState();break;case winState:renderWinState();break;case loseState:renderLoseState()}needShowFPSInfo&&(canvas.textAlign="end",canvas.fillText("FPS: "+Math.round(fps),width-30,50))}
function renderSelectLevelState(){camera.render();canvas.fillStyle="#FFFFFF";canvas.textAlign="center";canvas.fillText("Level: "+(levelId+1),.5*width,.25*height-.17*minSize);canvas.fillText("need apples: "+level.applesNeed,.5*width,.25*height-.1*minSize);canvas.fillText("rocks on level: "+level.needRocks,.5*width,.25*height-.03*minSize);drawEntranceIcon(.5*width,height-.1*minSize,.1*minSize);drawArrowLeft(.1*minSize,height-.1*minSize,.1*minSize);drawArrowRight(width-.1*minSize,height-.1*minSize,.1*
minSize)}
function drawEntranceIcon(a,b,c){canvas.fillStyle="#FFFFFF33";canvas.strokeStyle="#FFFFFF11";canvas.beginPath();canvas.arc(a+.2*c,b,.6*c,.75*Math.PI,1.25*Math.PI,!0);canvas.arc(a+.2*c,b,.4*c,1.25*Math.PI,.75*Math.PI);canvas.closePath();canvas.fill();canvas.stroke();canvas.beginPath();canvas.moveTo(a,b);canvas.lineTo(a-.4*c,b+.4*c);canvas.lineTo(a-.4*c,b+.12*c);canvas.lineTo(a-.76*c,b+.12*c);canvas.lineTo(a-.76*c,b-.12*c);canvas.lineTo(a-.4*c,b-.12*c);canvas.lineTo(a-.4*c,b-.4*c);canvas.closePath();canvas.fill();
canvas.stroke()}
function drawExitIcon(a,b,c){canvas.fillStyle="#FFFFFF33";canvas.strokeStyle="#FFFFFF11";canvas.beginPath();canvas.arc(a+.2*c,b,.5*c,.838*Math.PI,1.162*Math.PI,!0);canvas.arc(a+.2*c,b,.3*c,1.3*Math.PI,.7*Math.PI);canvas.closePath();canvas.fill();canvas.stroke();canvas.beginPath();canvas.moveTo(a+.04*c-.8*c,b);canvas.lineTo(a+.04*c-.4*c,b+.4*c);canvas.lineTo(a+.04*c-.4*c,b+.12*c);canvas.lineTo(a+.04*c-.04*c,b+.12*c);canvas.lineTo(a+.04*c-.04*c,b-.12*c);canvas.lineTo(a+.04*c-.4*c,b-.12*c);canvas.lineTo(a+
.04*c-.4*c,b-.4*c);canvas.closePath();canvas.fill();canvas.stroke()}function drawRestartIcon(a,b,c){canvas.fillStyle="#FFFFFF33";canvas.strokeStyle="#FFFFFF11";canvas.beginPath();canvas.arc(a,b,.6*c,.5*Math.PI,.2*Math.PI);canvas.arc(a,b,.4*c,.2*Math.PI,.5*Math.PI,!0);canvas.lineTo(a,b+.3*c);canvas.lineTo(a+.3*c,b+.5*c);canvas.lineTo(a,b+.7*c);canvas.closePath();canvas.fill();canvas.stroke()}
function drawArrowRight(a,b,c){canvas.fillStyle="#FFFFFF33";canvas.strokeStyle="#FFFFFF11";canvas.beginPath();canvas.moveTo(a+.5*c,b);canvas.lineTo(a,b+.5*c);canvas.lineTo(a-.5*c,b+.5*c);canvas.lineTo(a,b);canvas.lineTo(a-.5*c,b-.5*c);canvas.lineTo(a,b-.5*c);canvas.closePath();canvas.fill();canvas.stroke()}
function drawArrowLeft(a,b,c){canvas.fillStyle="#FFFFFF33";canvas.strokeStyle="#FFFFFF11";canvas.beginPath();canvas.moveTo(a-.5*c,b);canvas.lineTo(a,b+.5*c);canvas.lineTo(a+.5*c,b+.5*c);canvas.lineTo(a,b);canvas.lineTo(a+.5*c,b-.5*c);canvas.lineTo(a,b-.5*c);canvas.closePath();canvas.fill();canvas.stroke()}
function drawMenuIcon(a,b,c){canvas.fillStyle="#FFFFFF33";canvas.strokeStyle="#FFFFFF11";canvas.rect(a-.5*c,b+.3*c,c,.2*c);canvas.rect(a-.5*c,b-.1*c,c,.2*c);canvas.rect(a-.5*c,b-.5*c,c,.2*c);canvas.fill();canvas.stroke()}function renderWinState(){camera.render();canvas.fillStyle="#FFFFFF";canvas.textAlign="center";canvas.fillText("YOU WIN!",.5*width,.1*height);drawExitIcon(.13*minSize,height-.1*minSize,.12*minSize);drawArrowRight(width-.1*minSize,height-.1*minSize,.1*minSize)}
function renderLoseState(){camera.render();canvas.fillStyle="#FFFFFF";canvas.textAlign="center";canvas.fillText("YOU LOSE!",.5*width,.1*height);drawExitIcon(.13*minSize,height-.1*minSize,.12*minSize);drawRestartIcon(width-.1*minSize,height-.1*minSize,.1*minSize)}
function renderPauseState(){camera.render();canvas.fillStyle="#FFFFFF";canvas.textAlign="center";canvas.fillText("PAUSE",.5*width,.1*height);canvas.textAlign="start";canvas.textBaseline="middle";canvas.fillText(level.applesCount+"/"+level.applesNeed,.15*minSize,.1*minSize);drawApple(.1*minSize,.1*minSize,.046*minSize);for(var a=0;a<level.livesCount;a++)drawLiveHeart(.5*width+(a-1)*minSize*.05,height-.1*minSize,.05*minSize);drawMenuIcon(width-.1*minSize,.1*minSize,.08*minSize);drawExitIcon(.13*minSize,
height-.1*minSize,.12*minSize);drawRestartIcon(width-.1*minSize,height-.1*minSize,.1*minSize)}function renderStartGameState(){camera.render();var a=parseInt(255*Math.max(0,1-Math.abs(3*changeLevelAnim-1.5)));canvas.fillStyle=rgbToHex(0,0,0,a);canvas.fillRect(0,0,width,height)}
function renderGameState(){camera.render();canvas.fillStyle="#FFFFFF";canvas.textAlign="start";canvas.textBaseline="middle";canvas.fillText(level.applesCount+"/"+level.applesNeed,.15*minSize,.1*minSize);drawApple(.1*minSize,.1*minSize,.046*minSize);for(var a=0;a<level.livesCount;a++)drawLiveHeart(.5*width+(a-1)*minSize*.05,height-.1*minSize,.05*minSize);drawMenuIcon(width-.1*minSize,.1*minSize,.08*minSize);drawArrowLeft(.1*minSize,height-.1*minSize,.1*minSize);drawArrowRight(width-.1*minSize,height-
.1*minSize,.1*minSize)}function drawLiveHeart(a,b,c){c=void 0===c?10:c;canvas.fillStyle="#FF0000";canvas.beginPath();canvas.moveTo(a,b+.5*c);canvas.arc(a-.175*c,b,.25*c,.75*Math.PI,1.75*Math.PI);canvas.arc(a+.175*c,b,.25*c,1.25*Math.PI,2.25*Math.PI);canvas.closePath();canvas.fill()}function drawApple(a,b,c){c=void 0===c?10:c;canvas.fillStyle="#33FF33";canvas.beginPath();canvas.arc(a,b,.5*c,0,2*Math.PI);canvas.closePath();canvas.fill()}
function update(a){switch(state){default:case selectLevelState:updateSelectLevelState(a);break;case startGameState:updateStartGameState(a);break;case pauseState:updatePauseState(a);break;case winState:updateWinState(a);break;case loseState:updateLoseState(a);break;case gameState:updateGameState(a)}input.keyDown[115]&&(needShowFPSInfo=!needShowFPSInfo,console.log(Camera.instance.objects.length))}
function updateSelectLevelState(a){if(0<changeLevelAnim)changeLevelAnim-=3*a,0>changeLevelAnim&&(changeLevelAnim=0),a=2*(changeLevelAnim-.5),0<a?camera.cameraPosition=CreateVector3(30*(1-a*a)*changeLevelDirection,0,20):(level.id!=levelId&&level.setLevel(levelId),camera.cameraPosition=CreateVector3(30*(-1+a*a)*changeLevelDirection,0,20));else{input.keyDown[32]&&setState(startGameState);(input.keyPressed[65]||input.keyPressed[37])&&0<levelId&&(changeLevelAnim=1,changeLevelDirection=-1,--levelId);if(input.keyPressed[68]||
input.keyPressed[39])changeLevelDirection=changeLevelAnim=1,levelId+=1;input.isTouchDownInRect(0,.5*height,.3*width,height)&&0<levelId&&(changeLevelAnim=1,changeLevelDirection=-1,--levelId);input.isTouchDownInRect(.7*width,.5*height,width,height)&&(changeLevelDirection=changeLevelAnim=1,levelId+=1);input.isTouchDownInRect(.4*width,.5*height,.6*width,height)&&setState(startGameState);level.update(a);currentMatrix=MultiplyMatrix3(currentMatrix,CreateRotationMatrix3(rotationAxe,20*a));rotationAxe=NormalizeVector3(CreateVector3(100*
rotationAxe[0]+(2*Math.random()-1),100*rotationAxe[1]+(2*Math.random()-1),100*rotationAxe[2]+(2*Math.random()-1)));camera.worldMatrix=currentMatrix;camera.position=MultiplyVector3(camera.position,1-1*a);input.keyDown[113]&&(needShowDebugInfo=!needShowDebugInfo,level.showDebugInfo(needShowDebugInfo))}}
function updateWinState(a){if(0<changeLevelAnim)changeLevelAnim-=3*a,0>changeLevelAnim&&(changeLevelAnim=0),a=2*(changeLevelAnim-.5),0<a?camera.cameraPosition=CreateVector3(30*(1-a*a)*changeLevelDirection,0,15):(level.id!=levelId&&level.setLevel(levelId),camera.cameraPosition=CreateVector3(30*(-1+a*a)*changeLevelDirection,0,15));else if(level.id==levelId)setState(startGameState);else{input.keyDown[27]&&(--levelId,setState(selectLevelState));input.keyDown[32]&&(changeLevelDirection=changeLevelAnim=
1);if(input.keyDown[65]||input.keyDown[37])--levelId,setState(selectLevelState);if(input.keyDown[68]||input.keyDown[39])changeLevelDirection=changeLevelAnim=1;input.isTouchDownInRect(0,.5*height,.3*width,height)&&(--levelId,setState(selectLevelState));input.isTouchDownInRect(.7*width,0,width,height)&&(changeLevelDirection=changeLevelAnim=1);level.update(a)}}
function updateStartGameState(a){if(0<changeLevelAnim){var b=changeLevelAnim-1*a;.5>=b&&.5<changeLevelAnim&&level.setLevel(levelId);changeLevelAnim=b;0>changeLevelAnim&&(changeLevelAnim=0);.5>changeLevelAnim&&(level.update(a),camera.position=level.snake.position,a=getCameraRotation(level.snake.position),camera.worldMatrix=MultiplyMatrix3(CreateRotationMatrix3(CreateVector3(1),a[0]),CreateRotationMatrix3(CreateVector3(0,1),a[1])))}else setState(gameState)}
function updateLoseState(a){input.keyDown[27]&&setState(selectLevelState);input.keyDown[32]&&setState(startGameState);(input.keyDown[65]||input.keyDown[37])&&setState(selectLevelState);(input.keyDown[68]||input.keyDown[39])&&setState(startGameState);input.isTouchDownInRect(0,.5*height,.3*width,height)&&setState(selectLevelState);input.isTouchDownInRect(.7*width,0,width,height)&&setState(selectLevelState);level.update(a)}
function updatePauseState(a){input.keyDown[27]&&setState(gameState);(input.keyDown[65]||input.keyDown[37])&&setState(selectLevelState);(input.keyDown[68]||input.keyDown[39])&&setState(startGameState);input.isTouchDownInRect(.7*width,0,width,.3*height)&&setState(gameState);input.isTouchDownInRect(0,.5*height,.3*width,height)&&setState(selectLevelState);input.isTouchDownInRect(.7*width,.5*height,width,height)&&setState(startGameState)}
function updateGameState(a){input.keyDown[27]&&setState(pauseState);input.isTouchDownInRect(.7*width,0,width,.3*height)&&setState(pauseState);var b=0;if(input.keyPressed[65]||input.keyPressed[37])b=1;if(input.keyPressed[68]||input.keyPressed[39])b=-1;input.isTouchInRect(0,.5*height,.5*width,height)&&(b=1);input.isTouchInRect(.5*width,.5*height,width,height)&&(b=-1);level.snake.rotate(b);level.snake.update(a);level.update(a);camera.position=level.snake.position;a=getCameraRotation(level.snake.position);
camera.worldMatrix=MultiplyMatrix3(CreateRotationMatrix3(CreateVector3(1),a[0]),CreateRotationMatrix3(CreateVector3(0,1),a[1]));input.keyDown[113]&&(needShowDebugInfo=!needShowDebugInfo,level.showDebugInfo(needShowDebugInfo));level.applesNeed<=level.applesCount&&setState(winState);0>=level.livesCount&&setState(loseState)}
function getCameraRotation(a){a=NormalizeVector3(a);var b=NormalizeVector2([a[0],a[2]]);b=Math.acos(b[0])/Math.PI*180;var c=Math.acos(a[1])/Math.PI*180-90;b=0<a[2]?b+90:90-b;return[c,b]}
function setState(a){switch(a){default:case selectLevelState:currentMatrix=camera.worldMatrix;level.hideLevelDetails();break;case startGameState:changeLevelAnim=1;break;case pauseState:break;case gameState:if(state!=pauseState){for(var b=0;30>b;b++)level.snake.update(1/30);level.start()}break;case winState:level.hideLevelDetails();levelId+=1;break;case loseState:level.hideLevelDetails()}state=a}
function frame(){var a=timestamp(),b=(a-time)/1E3;fps=1/b;b>minDt&&(b=minDt);update(b);render();time=a;requestAnimationFrame(frame);if(width!=document.documentElement.clientWidth||height!=document.documentElement.clientHeight)width=document.documentElement.clientWidth,height=document.documentElement.clientHeight,minSize=Math.min(width,height),SetCanvasSize(width,height);input.updateInput()}requestAnimationFrame(frame);
function SetCanvasSize(a,b){canvasElement.width=a;canvasElement.height=b;camera.setSize(a,b);var c=32;b>a&&(c*=b/a);canvas.font=parseInt(c)+"pt Arial"};
	
	</script>
</html>